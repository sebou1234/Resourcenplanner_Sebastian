<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ressourcenplaner – Lokal (Single‑User)</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#16181d; --muted:#22252c; --text:#eef2f7; --sub:#b9c1d1; --acc:#61dafb; --ok:#2ecc71; --warn:#ffb347; --bad:#ff6b6b;
      --sunday-rose: rgba(255,99,71,0.08);
      --sunday-rose-strong: rgba(255,99,71,0.12);
      --gantt-bg: #0e1620;
      --gantt-head: #0b1420;
      --project-gap: 10px;
    }
    html,body{height:100%; background:var(--bg); color:var(--text); font:14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0}
    *{box-sizing:border-box}
    header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--card);border-bottom:1px solid #222;position:sticky;top:0;z-index:10}
    header h1{font-size:16px;margin:0;font-weight:600}
    header .spacer{flex:1}
    button,input,select{background:var(--muted);color:var(--text);border:1px solid #2b2f38;border-radius:10px;padding:8px 10px}
    button:hover{filter:brightness(1.08)}
    .layout{display:grid;grid-template-columns:300px 1fr; height:calc(100% - 58px);}
    aside{border-right:1px solid #222;background:var(--card);padding:14px;overflow:auto}
    main{padding:14px; overflow:auto}
    h2{font-size:13px;margin:14px 0 6px;color:var(--sub);font-weight:600;text-transform:uppercase;letter-spacing:.04em}
    .list{display:flex;flex-direction:column;gap:8px}
    .row{display:flex;align-items:center;gap:8px}
    .tag{background:#2b2f38;border:1px solid #39404d;border-radius:999px;padding:4px 8px;color:#c6d1e6;font-size:12px;min-width:140px;display:inline-block}
    .tag .dept{font-weight:600;margin-left:8px;color:var(--sub);font-size:11px}
    .card{background:var(--card);border:1px solid #222;border-radius:14px;padding:12px}
    .grid{border-collapse:separate;border-spacing:0}
    .grid th,.grid td{border:1px solid #2b2f38;padding:6px 8px;vertical-align:middle}
    .sticky{position:sticky;left:0;background:var(--card);z-index:5}
    .head-sticky{position:sticky;top:0;background:var(--card);z-index:6}
    .dept{min-width:260px}
    .cell{cursor:pointer}
    .gcell-on{background:#263246}

/* Farben pro Phase (wenn aktiv) */
td[data-phase="MD"].gcell-on          { background: rgba(96,165,250,0.18); } /* blau */
td[data-phase="ED"].gcell-on          { background: rgba(253,224,71,0.12); } /* gelb */
td[data-phase="PUR"].gcell-on         { background: rgba(168,85,247,0.12); } /* violett */
td[data-phase="SOW_OFF"].gcell-on     { background: rgba(16,185,129,0.12); } /* grün */
td[data-phase="MA"].gcell-on          { background: rgba(249,115,22,0.12); } /* orange */
td[data-phase="EA"].gcell-on          { background: rgba(14,165,233,0.12); } /* cyan */
td[data-phase="SOW_ON"].gcell-on      { background: rgba(99,102,241,0.12); } /* indigo */
td[data-phase="CUS"].gcell-on         { background: rgba(239,68,68,0.12); }  /* rot */

    /* Sunday highlight */
    .sunday{ background: var(--sunday-rose); }
    .head-sticky.sunday{ background: var(--sunday-rose-strong); }

    /* Scaling for span choices (adjust min-width) */
    body.span-2 .grid th, body.span-2 .grid td { min-width:98px; }
    body.span-4 .grid th, body.span-4 .grid td { min-width:70px; }
    body.span-8 .grid th, body.span-8 .grid td { min-width:52px; }
    body.span-16 .grid th, body.span-16 .grid td { min-width:40px; }

    /* Gantt specific */
    .gantt-cell{height:36px}
    .project-gap-row td{border:none;height:var(--project-gap);background:transparent}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:50}
    .modal-overlay.open{display:flex}
    .modal{background:var(--card);border:1px solid #222;border-radius:12px;padding:16px;min-width:360px;max-width:95%;max-height:90%;overflow:auto;color:var(--text)}
    .modal h3{margin:0;font-size:15px}
    .modal .modal-head{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .modal table{width:100%;border-collapse:collapse;margin-top:6px;white-space:nowrap}
    .modal th,.modal td{padding:6px 8px;border-bottom:1px solid #2b2f38;text-align:left}
    .modal .close{margin-left:auto;padding:6px 8px}
    .modal .project-cell{font-size:13px;color:var(--text)}
    .modal .empty{color:#9aa3b6;font-style:italic}

    /* Multi‑select menu (Dropdown) */
    .menu{
      position:fixed; /* use viewport coords from getBoundingClientRect */
      display:none;
      background:var(--card);
      border:1px solid #222;
      border-radius:10px;
      padding:10px;
      z-index:120;
      min-width:260px;
      max-width:min(60vw,420px);
      max-height:60vh;
      overflow:auto;
      box-shadow: 0 8px 28px rgba(0,0,0,0.6);
    }
    .menu.open{ display:block; }
    .menu input[type="search"]{ width:100%; padding:6px; margin-bottom:8px; border-radius:6px; border:1px solid #2b2f38; background:#0b0c10; color:var(--text) }
    .menu .item{ display:flex; align-items:center; gap:8px; padding:6px 4px; cursor:pointer; white-space:nowrap }
    .menu .item input{ margin-right:6px }
    .menu button{ display:block; width:100%; margin-bottom:8px }

    /* Resource list controls */
    .res-row{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .res-controls{display:flex;gap:6px;align-items:center}
    .dept-select{padding:6px;border-radius:8px;background:#121417;color:var(--text);border:1px solid #2b2f38}

    /* füge im <style> ein */
    td.gcell-trans {
      /* weiterhin "transparent" im Sinne von nicht voll gefüllt,
         aber jetzt sichtbar: leichter Pattern + leichter Hintergrund */
      background-image:
        linear-gradient(135deg, rgba(255,255,255,0.02) 25%, transparent 25%),
        linear-gradient(225deg, rgba(255,255,255,0.02) 25%, transparent 25%),
        linear-gradient(45deg, rgba(255,255,255,0.02) 25%, transparent 25%),
        linear-gradient(315deg, rgba(255,255,255,0.02) 25%, transparent 25%);
      background-size: 8px 8px;
      background-color: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.02);
    }

    /* leicht unterscheidbare sichtbare Farbfüllung (falls zusätzlich gewünscht) */
    td.gcell-on { /* bestehende Regel bleibt, ggf anpassen */ }

    /* Übersicht Modal (großes GANTT zum Malen) */
    #ganttOverviewModal .modal { width: 95vw; max-width:1600px; max-height:90vh; }
    #ganttOverviewModal table.grid { width:100%; }
    #ganttOverviewModal td.res-mark { background: rgba(200,200,200,0.06); } /* Ressource markierung */
  </style>
</head>
<body>
  <header>
    <h1>Ressourcenplaner (lokal, Single‑User)</h1>
    <div class="spacer"></div>
    <div class="toolbar">
      <label>Start‑Datum:
        <input type="date" id="startDate">
      </label>
      <button id="prevWeek">◀ Woche</button>
      <button id="nextWeek">Woche ▶</button>

      <!-- Zeitspanne Umschalter -->
      <label for="spanSelect">Zeitraum:
        <select id="spanSelect" title="Zeige 2 / 4 / 8 / 16 Wochen">
          <option value="2">2 Wochen</option>
          <option value="4">4 Wochen</option>
          <option value="8">8 Wochen</option>
          <option value="16">16 Wochen</option>
        </select>
      </label>

      <button id="overviewBtn">Mitarbeiter‑Übersicht</button>
      <button id="exportBtn">Export JSON</button>
      <input type="file" id="importFile" style="display:none" accept="application/json"/>
      <button id="importBtn">Import JSON</button>
      <button id="ganttPaintModeBtn" title="Wechsel zwischen farbig / transparent">Modus: Farbe</button>
      <button id="ganttOverviewBtn" title="32-Wochen GANTT‑Übersicht">GANTT‑Übersicht</button>
    </div>
  </header>

  <div class="layout">
    <aside>
      <h2>Projekte (ein-/ausblenden)</h2>
      <div id="projectFilters" class="filters"></div>
      <div class="row" style="margin-top:6px;gap:6px">
        <button id="btnAllOn">Alle an</button>
        <button id="btnAllOff">Alle aus</button>
        <button id="addProjectBtn">+ Projekt</button>
        <button id="renameProjectBtn">Umbenennen</button>
      </div>

      <h2 style="margin-top:16px">Mitarbeiter</h2>
      <div class="row">
        <input id="newRes" placeholder="Name hinzufügen…" />
        <select id="newResDept" class="dept-select" title="Abteilung">
          <option>MD</option><option>ED</option><option>SOW</option><option>MA</option><option>EA</option><option>PM</option>
        </select>
        <button id="addResBtn">Hinzufügen</button>
      </div>
      <div id="resList" class="list" style="margin-top:8px"></div>

      <h2 style="margin-top:18px">Konflikte</h2>
      <div id="conflicts" class="list"></div>
      <p class="small" style="margin-top:10px">Konflikt = Person ist am selben Tag in mehreren Projekten eingeplant.</p>
    </aside>

    <main>
      <div class="card">
        <div class="toolbar" style="margin-bottom:10px">
          <span class="pill">Zeitraum‑Anzeige: <strong id="rangeLabel"></strong></span>
          <span class="pill ok" id="stats"></span>
        </div>
        <div style="overflow:auto">
          <table class="grid" id="grid"></table>
        </div>
        <div class="foot small">Tipp: Doppel‑Klick auf eine Abteilungs‑Zelle löscht alle Mitarbeitereinträge (mit Bestätigung). In Abteilungs‑Zellen Klick → Mitarbeitende auswählen (Mehrfachauswahl). 10 h/Tag pro Person. Trenner „ | “.</div>
      </div>
    </main>
  </div>

  <!-- Multi‑Select Menu -->
  <div id="multiMenu" class="menu"></div>

  <!-- ===== Mitarbeiterübersicht Modal (neu) ===== -->
  <div id="overviewModal" class="modal-overlay" role="dialog" aria-hidden="true">
    <div class="modal" role="document" aria-modal="true">
      <div class="modal-head">
        <h3 id="overviewTitle">Mitarbeiter‑Übersicht</h3>
        <button id="closeOverview" class="small">Schließen</button>
      </div>
      <div id="overviewContent" aria-live="polite"></div>
    </div>
  </div>

  <!-- ===== GANTT‑Übersicht Modal (neu) ===== -->
  <div id="ganttOverviewModal" class="modal-overlay" role="dialog" aria-hidden="true">
    <div class="modal" role="document" aria-modal="true">
      <div class="modal-head">
        <h3>GANTT‑Übersicht (32 Wochen)</h3>
        <button id="closeGanttOverview" class="small">Schließen</button>
      </div>
      <div id="ganttOverviewContent"></div>
    </div>
  </div>

  <script>
  // ====== Utility & constants ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const DEPTS = ['MD','ED','SOW','MA','EA','PM'];

// Phasen: eine Zeile je Phase pro Projekt (wie gewünscht)
const PHASES = [
  { key: 'MD',       label: 'MD' },
  { key: 'ED',       label: 'ED' },
  { key: 'PUR',      label: 'PUR' },
  { key: 'SOW_OFF',  label: 'SOW Offline' },
  { key: 'MA',       label: 'MA' },
  { key: 'EA',       label: 'EA' },
  { key: 'SOW_ON',   label: 'SOW Online' },
  { key: 'CUS',      label: 'Customer' },
];

// Drawing state for paint-mode
let isGanttDrawing = false;
let ganttDrawValue = null;
let ganttDrawPhase = null;
let ganttDrawProjectId = null;
let ganttPaintMode = 'color'; // 'color' | 'transparent'

function updateGanttPaintModeButton(){
  const btn = document.getElementById('ganttPaintModeBtn');
  if(!btn) return;
  btn.textContent = ganttPaintMode === 'color' ? 'Modus: Farbe' : 'Modus: Transparent';
}
document.addEventListener('DOMContentLoaded', updateGanttPaintModeButton);

// <-- Fehlende Konstanten ergänzt (wichtig) -->
const HOURS_PER_DAY = 10;
const STORAGE_KEY = 'resplan_v3';

  // Load / init state (with migration)
  const raw = load() || {};
  const state = raw || {};
  if(!state.resources) state.resources = ['Mitarbeiter 1','Mitarbeiter 2','Mitarbeiter 3'];
  if(!state.projects) state.projects = [{ id: crypto.randomUUID(), name: 'Projekt 1', visible: true, data: {} }, { id: crypto.randomUUID(), name: 'Projekt 2', visible: true, data: {} }];
  if(!state.ui) state.ui = { start: normStart(new Date().toISOString().slice(0,10)), weeks: 2 };

  // Migrate resources: strings -> objects {name,dept}
  state.resources = state.resources.map(r => {
    if(typeof r === 'string') return { name: r, dept: 'MD' };
    // already object
    return { name: r.name || 'Unnamed', dept: r.dept || 'MD' };
  });

  function normStart(dateStr){
    let d = new Date(dateStr||new Date());
    const START_MIN = new Date('2025-01-01');
    const END_MAX = new Date('2026-12-31');
    if(d < START_MIN) d = START_MIN;
    if(d > END_MAX) d = END_MAX;
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    d.setDate(d.getDate() + diff); // Monday
    return d.toISOString().slice(0,10);
  }

  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); render(); }
  function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch(e){ return null; } }

  // Elements
  const startDateInput = $('#startDate');
  const spanSelect = document.getElementById('spanSelect');

  // Init
  function init(){
    if(!state.ui) state.ui = { start: normStart(new Date().toISOString().slice(0,10)), weeks: 2 };
    if(typeof state.ui.weeks === 'undefined') state.ui.weeks = 2;
    state.ui.start = normStart(state.ui.start);
    startDateInput.value = state.ui.start;
    spanSelect.value = String(state.ui.weeks);
    spanSelect.onchange = (e)=>{ state.ui.weeks = parseInt(e.target.value,10) || 2; applySpanClass(); save(); };

    buildProjectFilters();
    render();
    applySpanClass();
  }

  // apply body class for scaling
  function applySpanClass(){
    document.body.classList.remove('span-2','span-4','span-8','span-16');
    const cls = `span-${state.ui.weeks}`;
    document.body.classList.add(cls);
  }

  // compute days array for current span (day resolution)
  function rangeDays(){
    const start = new Date(state.ui.start);
    const totalDays = (state.ui.weeks || 2) * 7;
    const days = [...Array(totalDays)].map((_,i)=> new Date(start.getFullYear(), start.getMonth(), start.getDate()+i));
    return days;
  }

  // compute week starts (Mondays) for Gantt rows
  function rangeWeeks(){
    const start = new Date(state.ui.start);
    const weeks = state.ui.weeks || 2;
    return [...Array(weeks)].map((_,i)=> {
      const d = new Date(start.getFullYear(), start.getMonth(), start.getDate() + i*7);
      d.setHours(0,0,0,0);
      return d;
    });
  }

  function rangeWeeksFrom(startISO, count){
    const s = new Date(startISO);
    s.setHours(0,0,0,0);
    return [...Array(count)].map((_,i)=>{
      const d = new Date(s.getFullYear(), s.getMonth(), s.getDate() + i*7);
      d.setHours(0,0,0,0);
      return d;
    });
  }

  // Rendering
  function render(){
    const days = rangeDays();
    $('#rangeLabel').textContent = days.length ? `${days[0].toLocaleDateString('de-AT')} – ${days[days.length-1].toLocaleDateString('de-AT')}` : '';
    $('#stats').textContent = `${state.resources.length} Personen • ${state.projects.length} Projekt(e) • ${state.ui.weeks} Wochen`;

    const grid = $('#grid'); grid.innerHTML = '';

    // header
    const thead = document.createElement('thead');
    const hr = document.createElement('tr');
    const empty = document.createElement('th'); empty.className = 'head-sticky sticky dept'; empty.textContent='Beschreibung / Fachabteilung'; hr.appendChild(empty);

    days.forEach(d=>{
      const th = document.createElement('th'); th.className='head-sticky';
      if(d.getDay()===0) th.classList.add('sunday');
      th.textContent = fmtCW(d) + ' ' + d.toLocaleDateString('de-AT',{day:'2-digit', month:'2-digit'});
      hr.appendChild(th);
    });
    thead.appendChild(hr);
    grid.appendChild(thead);

    const tbody = document.createElement('tbody');

    // Für jedes sichtbare Projekt: Header, dann GANTT-Phasen (je Phase eine Zeile, Wochen-Zellen)
    state.projects.filter(p=>p.visible!==false).forEach((p)=>{
      // erzeugen timeline row (kopie der Kopfzeile, aber kleiner)
      const timeline = document.createElement('tr');
      const tEmpty = document.createElement('th');
      tEmpty.className = 'head-sticky sticky dept';
      tEmpty.textContent = ''; // leer über der Projektspalte
      timeline.appendChild(tEmpty);
      days.forEach(d=>{
        const th = document.createElement('th');
        if(d.getDay()===0) th.classList.add('sunday');
        th.className = 'head-sticky';
        th.textContent = fmtCW(d);
        timeline.appendChild(th);
      });
      tbody.appendChild(timeline);

      // jetzt wie vorher das project header row (pr)
      const pr = document.createElement('tr');
      const cell = document.createElement('th');
      cell.className = 'sticky dept projHeader';
      cell.textContent = p.name;
      pr.appendChild(cell);
      days.forEach(d=>{
        const td = document.createElement('td');
        td.style.background = '#0e1218';
        if(d.getDay()===0) td.classList.add('sunday');
        pr.appendChild(td);
      });
      tbody.appendChild(pr);

      // GANTT: eine Zeile pro PHASE, jede Zelle = eine Woche (click toggles)
      PHASES.forEach(phase=>{
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.className = 'sticky dept ganttHead';
        th.textContent = phase.label;
        tr.appendChild(th);

        rangeWeeks().forEach(weekStart=>{
          const td = document.createElement('td');
          td.className = 'gantt-cell ganttRow';
          // mark sunday visually on the week's sunday
          const sunday = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate()+6);
          if(sunday.getDay()===0) td.classList.add('sunday');

          const weekISO = weekStart.toISOString().slice(0,10);
          const key = `${weekISO}|W_${p.id}_${phase.key}`;
          td.dataset.phase = phase.key;
          td.colSpan = 7;
          td.style.cursor = 'default'; // nicht interaktiv in der Normalansicht

          // Darstellung: '#t' ist die "transparent"-Markierung (immer verwendet)
          if(p.data[key] === '#t'){
            td.classList.add('gcell-trans');
          } else {
            td.classList.remove('gcell-trans');
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      // danach weiterhin die tagebasierten DEPTS rows wie gehabt
      DEPTS.forEach(dep=>{
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.className='sticky dept';
        th.textContent = deptLabel(dep);
        tr.appendChild(th);

        days.forEach(d=>{
          const td = document.createElement('td'); td.className='cell';
          if(d.getDay()===0) td.classList.add('sunday');
          const dayISO = d.toISOString().slice(0,10);
          const key = `${dayISO}|D_${dep}`;
          td.textContent = p.data[key] || '';
          td.addEventListener('click', ()=> openMulti(td, dayISO, dep, p));
          td.addEventListener('dblclick', ()=>{
            if(!p.data[key]) return;
            if(confirm(`Alle Mitarbeitenden am ${new Date(dayISO).toLocaleDateString('de-AT')} für Projekt "${p.name}" entfernen?`)){
              p.data[key] = '';
              save();
            }
          });
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      // Sum row
      const sr = document.createElement('tr'); const sth = document.createElement('th');
      sth.className='sticky dept sum'; sth.textContent='Summe Stunden (10 h × Anzahl Namen)'; sr.appendChild(sth);
      days.forEach(d=>{
        const td = document.createElement('td'); td.className='sum';
        if(d.getDay()===0) td.classList.add('sunday');
        td.textContent = String(sumHoursForDay(p, d.toISOString().slice(0,10)));
        sr.appendChild(td);
      });
      tbody.appendChild(sr);

      // project gap row
      const gap = document.createElement('tr'); gap.className='project-gap-row';
      const gapTd = document.createElement('td'); gapTd.colSpan = days.length + 1;
      gap.appendChild(gapTd);
      tbody.appendChild(gap);
    });

    grid.appendChild(tbody);

    renderResources();
    renderConflicts();
  }

  function deptLabel(dep){
    switch(dep){
      case 'MD': return 'MD (Mechanic Design)';
      case 'ED': return 'ED (Electrical Design)';
      case 'SOW': return 'SOW (Software)';
      case 'MA': return 'MA (Mechanical Assembly)';
      case 'EA': return 'EA (Electrical Assembly)';
      case 'PM': return 'PM (Project Management)';
      default: return dep;
    }
  }

  function sumHoursForDay(project, dayISO){
    let total = 0;
    DEPTS.forEach(dep=>{
      const key = `${dayISO}|D_${dep}`;
      const s = project.data[key] || '';
      if(s.trim()){
        const n = s.split(' | ').filter(Boolean).length;
        total += n * HOURS_PER_DAY;
      }
    });
    return total;
  }

  // ===== Multi‑Select (per project) ======
  const menu = $('#multiMenu'); let menuAnchor = null; let menuCtx = null;
  function openMulti(anchor, dayISO, dep, project){
    menuAnchor = anchor; menuCtx = { dayISO, dep, project };
    const rect = anchor.getBoundingClientRect();
    menu.style.left = `${Math.max(8, rect.left)}px`;
    menu.style.top = `${rect.bottom + 6}px`;
    menu.innerHTML = '';

    const search = document.createElement('input'); search.type='search'; search.placeholder='Suchen…'; menu.appendChild(search);

    const btnClear = document.createElement('button'); btnClear.textContent = 'Alle entfernen'; btnClear.style.marginBottom = '8px';
    btnClear.onclick = ()=>{
      if(confirm('Alle Mitarbeitenden aus dieser Zelle entfernen?')){
        const key = `${dayISO}|D_${dep}`; project.data[key] = ''; save();
      }
    };
    menu.appendChild(btnClear);

    const list = document.createElement('div'); menu.appendChild(list);

    function rebuild(){
      list.innerHTML = '';
      const filter = (search.value || '').toLowerCase();
      const selected = getCellAssignments(project, dayISO, dep);
      state.resources.filter(r=> r.name.toLowerCase().includes(filter)).forEach(res=>{
        const it = document.createElement('label'); it.className='item';
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = selected.includes(res.name);
        cb.addEventListener('change', ()=> toggleAssign(res.name));
        const span = document.createElement('span'); span.textContent = res.name + ' ';
        const dspan = document.createElement('span'); dspan.className='dept'; dspan.textContent = res.dept;
        span.appendChild(dspan);
        it.appendChild(cb); it.appendChild(span); list.appendChild(it);
      });
    }
    function toggleAssign(name){
      const key = `${dayISO}|D_${dep}`; const cur = (project.data[key] || '').split(' | ').filter(Boolean);
      const idx = cur.indexOf(name); if(idx>=0) cur.splice(idx,1); else cur.push(name);
      project.data[key] = cur.join(' | ');
      save();
    }
    search.addEventListener('input', rebuild);
    menu.classList.add('open'); rebuild();
    const close = (e) => { if(e && (menu.contains(e.target) || e.target === anchor)) return; menu.classList.remove('open'); document.removeEventListener('mousedown', close); };
    setTimeout(()=> document.addEventListener('mousedown', close));
  }

  function getCellAssignments(project, dayISO, dep){ const key = `${dayISO}|D_${dep}`; const s = project.data[key] || ''; return s ? s.split(' | ').filter(Boolean) : []; }

  // ===== Resource management (list, add, rename, change dept, delete) ======
  function renderResources(){
    const box = $('#resList'); box.innerHTML = '';
    state.resources.forEach((res, i) => {
      const row = document.createElement('div'); row.className = 'res-row';
      const left = document.createElement('div');
      const tag = document.createElement('span'); tag.className='tag'; tag.textContent = res.name;
      const deptSpan = document.createElement('span'); deptSpan.className='dept'; deptSpan.textContent = res.dept;
      tag.appendChild(deptSpan);
      left.appendChild(tag);

      const controls = document.createElement('div'); controls.className='res-controls';
      const rename = document.createElement('button'); rename.textContent = 'Umbenennen';
      rename.onclick = ()=> {
        const newName = prompt('Neuer Name:', res.name);
        if(!newName) return;
        // update name in resources and in all project data (replace occurrences)
        const old = res.name;
        res.name = newName;
        state.projects.forEach(p=>{
          Object.entries(p.data).forEach(([k,v])=>{
            if(!v) return;
            const parts = v.split(' | ').map(x=>x.trim());
            const replaced = parts.map(x => x===old ? newName : x);
            p.data[k] = replaced.filter(Boolean).join(' | ');
          });
        });
        save();
      };
      const deptBtn = document.createElement('select');
      deptBtn.className = 'dept-select';
      DEPTS.concat(['PM']).forEach(d=>{
        const opt = document.createElement('option'); opt.value = d; opt.textContent = d;
        if(res.dept === d) opt.selected = true;
        deptBtn.appendChild(opt);
      });
      deptBtn.onchange = (e) => { res.dept = e.target.value; save(); };

      const del = document.createElement('button'); del.textContent = 'Löschen';
      del.onclick = ()=>{
        if(!confirm(`"${res.name}" wirklich löschen? Alle Zuweisungen bleiben als Text, entferne manuell in Zellen falls nötig.`)) return;
        state.resources.splice(i,1);
        // also remove from any project data cells
        state.projects.forEach(p=>{
          Object.keys(p.data).forEach(k=>{
            if(!p.data[k]) return;
            const arr = p.data[k].split(' | ').filter(Boolean).filter(x=> x !== res.name);
            p.data[k] = arr.join(' | ');
          });
        });
        save();
      };

      controls.appendChild(rename);
      controls.appendChild(deptBtn);
      controls.appendChild(del);

      row.appendChild(left);
      row.appendChild(controls);
      box.appendChild(row);
    });
  }

  $('#addResBtn').onclick = ()=>{
    const name = $('#newRes').value.trim();
    const dept = $('#newResDept').value || 'MD';
    if(!name) return;
    if(state.resources.some(r=> r.name === name)){ alert('Mitarbeiter existiert bereits'); return; }
    state.resources.push({ name, dept });
    $('#newRes').value = '';
    save();
  };

  // ===== Project filters/build =====
  function buildProjectFilters(){
    const box = $('#projectFilters'); box.innerHTML = '';
    state.projects.forEach((p,idx)=>{
      if(typeof p.visible === 'undefined') p.visible = true;
      const label = document.createElement('label');
      const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = p.visible;
      cb.onchange = ()=> { p.visible = cb.checked; save(); };
      const span = document.createElement('span'); span.textContent = p.name;
      label.appendChild(cb); label.appendChild(span); box.appendChild(label);
    });
  }
  $('#btnAllOn').onclick = ()=>{ state.projects.forEach(p=> p.visible=true); save(); buildProjectFilters(); };
  $('#btnAllOff').onclick = ()=>{ state.projects.forEach(p=> p.visible=false); save(); buildProjectFilters(); };
  $('#addProjectBtn').onclick = ()=>{ const name = prompt('Projektname?','Neues Projekt'); if(!name) return; state.projects.push({ id: crypto.randomUUID(), name, visible:true, data: {} }); save(); buildProjectFilters(); };
  $('#renameProjectBtn').onclick = ()=>{
    const names = state.projects.map((p,i)=> `${i+1}. ${p.name}`).join('\n');
    const idx = prompt(`Welche Projektnummer umbenennen?\n${names}`); const i = parseInt(idx,10)-1;
    if(isNaN(i)||i<0||i>=state.projects.length) return;
    const newName = prompt('Neuer Projektname:', state.projects[i].name); if(!newName) return;
    state.projects[i].name = newName; save(); buildProjectFilters();
  };

  // ===== Navigation =====
  startDateInput.onchange = (e)=>{ state.ui.start = normStart(e.target.value); save(); };
  $('#prevWeek').onclick = ()=>{ const d = new Date(state.ui.start); d.setDate(d.getDate() - 7); state.ui.start = normStart(d.toISOString().slice(0,10)); save(); };
  $('#nextWeek').onclick = ()=>{ const d = new Date(state.ui.start); d.setDate(d.getDate() + 7); state.ui.start = normStart(d.toISOString().slice(0,10)); save(); };

  // ===== Conflicts =====
  function renderConflicts(){
    const box = $('#conflicts'); box.innerHTML = '';
    const issues = findConflicts();
    if(!issues.length){ const ok = document.createElement('div'); ok.className='pill ok'; ok.textContent = 'Keine Konflikte'; box.appendChild(ok); return; }
    issues.sort((a,b)=>a.dateISO.localeCompare(b.dateISO) || a.name.localeCompare(b.name));
    issues.forEach(it=>{ const div = document.createElement('div'); div.className='conflict'; div.textContent = `${new Date(it.dateISO).toLocaleDateString('de-AT')}: ${it.name} (${it.cnt} Projekte)`; box.appendChild(div); });
  }
  function findConflicts(){
    const map = new Map(); // dateISO -> name -> count
    state.projects.forEach(p=>{
      Object.entries(p.data).forEach(([k,val])=>{
        const [dateISO,rowKey] = k.split('|'); if(!rowKey || !rowKey.startsWith('D_')) return; if(!val) return;
        const names = val.split(' | ').filter(Boolean);
        names.forEach(name=>{
          const m1 = map.get(dateISO) || new Map();
          m1.set(name, (m1.get(name)||0) + 1);
          map.set(dateISO, m1);
        });
      });
    });
    const issues = [];
    map.forEach((m,dateISO)=>{
      m.forEach((cnt,name)=>{
        if(cnt>1) issues.push({ dateISO, name, cnt });
      });
    });
    return issues;
  }

  // ===== Export / Import =====
  $('#exportBtn').onclick = ()=>{
    const exportState = JSON.parse(JSON.stringify(state));
    const blob = new Blob([JSON.stringify(exportState,null,2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ressourcenplan.json'; a.click(); URL.revokeObjectURL(a.href);
  };
  $('#importBtn').onclick = ()=> $('#importFile').click();
  $('#importFile').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const txt = await file.text();
    try{
      const data = JSON.parse(txt);
      // basic validation and merge
      if(data.resources) state.resources = data.resources.map(r => typeof r === 'string' ? { name: r, dept: 'MD' } : { name: r.name || 'Unnamed', dept: r.dept || 'MD' });
      if(data.projects) state.projects = data.projects;
      if(data.ui) state.ui = Object.assign(state.ui || {}, data.ui);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      init();
    }catch(err){ alert('Ungültige Datei'); }
  });

  // ===== Mitarbeiterübersicht: pro Tag Projekte =====
  function buildEmployeeOverview(){
    const days = rangeDays();
    const visibleProjects = state.projects.filter(p=> p.visible !== false);
    const overviewMap = new Map();
    state.resources.forEach(r => overviewMap.set(r.name, { name: r.name, perDay: days.map(()=>[]) }));

    visibleProjects.forEach(p=>{
      days.forEach((d, idx)=>{
        const dayISO = d.toISOString().slice(0,10);
        DEPTS.forEach(dep=>{
          const key = `${dayISO}|D_${dep}`;
          const cell = p.data[key] || '';
          if(!cell) return;
          const names = cell.split(' | ').filter(Boolean);
          names.forEach(n=>{
            if(!overviewMap.has(n)) overviewMap.set(n, { name: n, perDay: days.map(()=>[]) });
            const entry = overviewMap.get(n);
            if(!entry.perDay[idx].includes(p.name)) entry.perDay[idx].push(p.name);
          });
        });
      });
    });

    const overview = Array.from(overviewMap.values()).map(o=> ({ name: o.name, perDay: o.perDay.map(arr => arr.length ? arr.join(' | ') : '') })).sort((a,b)=> a.name.localeCompare(b.name));
    return { overview, days };
  }

  function showOverviewModal(){
    const { overview, days } = buildEmployeeOverview();
    const content = $('#overviewContent'); content.innerHTML = '';
    const hdr = document.createElement('div'); hdr.className='small muted';
    hdr.textContent = `Zeitraum: ${days[0]?.toLocaleDateString('de-AT') || '-'} – ${days[days.length-1]?.toLocaleDateString('de-AT') || '-'}`;
    content.appendChild(hdr);

    const tbl = document.createElement('table');
    const thead = document.createElement('thead'); const hdrRow = document.createElement('tr');
    const thName = document.createElement('th'); thName.textContent = 'Name'; hdrRow.appendChild(thName);
    days.forEach(d=>{
      const th = document.createElement('th');
      const weekday = d.toLocaleDateString('de-AT',{weekday:'short'});
      const shortDate = `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}`;
      th.textContent = `${weekday} ${shortDate}`;
      if(d.getDay()===0) th.classList.add('sunday');
      hdrRow.appendChild(th);
    });
    thead.appendChild(hdrRow); tbl.appendChild(thead);

    const tbody = document.createElement('tbody');
    overview.forEach(o=>{
      const tr = document.createElement('tr');
      const tdName = document.createElement('td'); tdName.textContent = o.name; tr.appendChild(tdName);
      o.perDay.forEach((cellText, idx)=>{
        const td = document.createElement('td'); td.className='project-cell';
        const d = days[idx]; if(d.getDay()===0) td.classList.add('sunday');
        td.innerHTML = cellText ? escapeHtml(cellText) : '<span class="empty">—</span>';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
    content.appendChild(tbl);

    const overlay = $('#overviewModal'); overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false');
    document.getElementById('closeOverview').focus();
  }

  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

  // handlers
  $('#overviewBtn').onclick = showOverviewModal;
  $('#closeOverview').onclick = ()=>{ const overlay = $('#overviewModal'); overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); };
  document.getElementById('overviewModal').addEventListener('click', (e)=>{ if(e.target === e.currentTarget){ e.currentTarget.classList.remove('open'); e.currentTarget.setAttribute('aria-hidden','true'); } });

  // keyboard
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){ document.querySelectorAll('.menu.open').forEach(m=>m.classList.remove('open')); const om = document.getElementById('overviewModal'); if(om) om.classList.remove('open'); }
    if(e.ctrlKey && e.key === 'ArrowLeft'){ $('#prevWeek').click(); }
    if(e.ctrlKey && e.key === 'ArrowRight'){ $('#nextWeek').click(); }
  });

  // --- NEW: ensure drawing stops on global mouseup and persist changes ---
  document.addEventListener('mouseup', ()=>{
  if(isGanttDrawing){
    isGanttDrawing = false;
    ganttDrawValue = null;
    ganttDrawPhase = null;
    ganttDrawProjectId = null;
    save(); // persist painting

    // Wenn die GANTT‑Übersicht offen ist: auch diese sofort neu rendern,
    // damit das gemalte Ergebnis in der Modal‑Ansicht sichtbar bleibt.
    const ov = document.getElementById('ganttOverviewModal');
    if(ov && ov.classList.contains('open')){
      try { renderGanttOverview(); } catch(e){ /* safe fallback */ }
    }
  }
});
  // Helpers
  function fmtCW(d){ const dow = d.toLocaleDateString('de-AT',{weekday:'short'}).slice(0,2).toUpperCase(); const w = getISOWeek(d); return `${dow} CW${String(w).padStart(2,'0')}`; }
  function getISOWeek(date){ const d = new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate())); const dayNum = d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-dayNum); const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d-yearStart)/86400000)+1)/7); }

  // Init app
  init();

  // Register button handlers
  document.getElementById('ganttPaintModeBtn').onclick = ()=>{
    ganttPaintMode = ganttPaintMode === 'color' ? 'transparent' : 'color';
    updateGanttPaintModeButton();
  };

  document.getElementById('ganttOverviewBtn').onclick = showGanttOverview;

  function showGanttOverview(){
    const modal = document.getElementById('ganttOverviewModal');
    modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
    renderGanttOverview();
  }

  document.getElementById('closeGanttOverview').onclick = ()=>{
    const modal = document.getElementById('ganttOverviewModal');
    modal.classList.remove('open'); modal.setAttribute('aria-hidden','true');
  };

  // Komplette neue Implementierung von renderGanttOverview()
  function renderGanttOverview(){
    const container = document.getElementById('ganttOverviewContent');
    container.innerHTML = '';

    const weeks = rangeWeeksFrom(state.ui.start, 32);
    const tbl = document.createElement('table'); tbl.className = 'grid';
    // header (CW per Woche)
    const thead = document.createElement('thead');
    const hr = document.createElement('tr');
    const empty = document.createElement('th'); empty.className='head-sticky sticky dept'; empty.textContent='Beschreibung / Fachabteilung'; hr.appendChild(empty);
    weeks.forEach(w=>{
      const th = document.createElement('th'); th.className='head-sticky';
      th.textContent = 'CW' + String(getISOWeek(w)).padStart(2,'0');
      if(w.getDay()===0) th.classList.add('sunday');
      hr.appendChild(th);
    });
    thead.appendChild(hr); tbl.appendChild(thead);

    const tbody = document.createElement('tbody');

    // Für jedes sichtbare Projekt: gleiche Struktur wie normal, aber Wochen statt Tage
    state.projects.filter(p=>p.visible!==false).forEach((p)=>{
      // timeline / project header row (Proj-Name row)
      const pr = document.createElement('tr');
      const cell = document.createElement('th');
      cell.className = 'sticky dept projHeader';
      cell.textContent = p.name;
      pr.appendChild(cell);
      weeks.forEach(w=>{
        const td = document.createElement('td');
        td.style.background = '#0e1218';
        if(w.getDay()===0) td.classList.add('sunday');
        pr.appendChild(td);
      });
      tbody.appendChild(pr);

      // PHASES: interaktiv in der Übersicht (malen)
      PHASES.forEach(phase=>{
        const tr = document.createElement('tr');
        const th = document.createElement('th'); th.className = 'sticky dept ganttHead'; th.textContent = phase.label; tr.appendChild(th);

        weeks.forEach(weekStart=>{
          const td = document.createElement('td');
          td.style.cursor = 'pointer';
          const weekISO = weekStart.toISOString().slice(0,10);
          const key = `${weekISO}|W_${p.id}_${phase.key}`;

          // Anzeige basierend auf '#t' flag (transparent markiert)
          if(p.data[key] === '#t') td.classList.add('gcell-trans'); else td.classList.remove('gcell-trans');

          // click toggles between off and '#t'
          td.addEventListener('click', (e)=>{
            p.data[key] = (p.data[key] === '#t') ? '' : '#t';
            save();
            renderGanttOverview(); // aktualisieren Übersicht
          });

          // painting: mousedown + mouseenter
          td.addEventListener('mousedown', (e)=>{
            e.preventDefault();
            isGanttDrawing = true;
            ganttDrawPhase = phase.key;
            ganttDrawProjectId = p.id;
            // paint value: if current empty -> set '#t', else erase
            ganttDrawValue = (p.data[key] === '') ? '#t' : '';
            p.data[key] = ganttDrawValue;
            if(ganttDrawValue === '#t') td.classList.add('gcell-trans'); else td.classList.remove('gcell-trans');
          });
          td.addEventListener('mouseenter', ()=>{
            if(isGanttDrawing && ganttDrawPhase === phase.key && ganttDrawProjectId === p.id){
              p.data[key] = ganttDrawValue;
              if(ganttDrawValue === '#t') td.classList.add('gcell-trans'); else td.classList.remove('gcell-trans');
            }
          });

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      // DEPT rows: mark week if irgendein Tag dieser Woche in Detailansicht belegt ist
      DEPTS.forEach(dep=>{
        const tr = document.createElement('tr');
        const th = document.createElement('th'); th.className='sticky dept'; th.textContent = deptLabel(dep); tr.appendChild(th);

        weeks.forEach(weekStart=>{
          const td = document.createElement('td');
          // check days in this week (7 days starting at weekStart)
          const daysOfWeek = [...Array(7)].map((_,i)=>{
            const d = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate()+i);
            return d.toISOString().slice(0,10);
          });
          // if any day cell for this project+dep has names -> mark week
          let marked = false;
          daysOfWeek.forEach(dayISO=>{
            const key = `${dayISO}|D_${dep}`;
            const val = p.data[key] || '';
            if(val && val.trim()) marked = true;
          });
          if(marked) td.classList.add('gcell-trans'); else td.classList.remove('gcell-trans');
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      // Sum row per project (Mark if any day has hours — optional: here we compute per-week sums? We'll mark per-week if any day has hours)
      const sr = document.createElement('tr'); const sth = document.createElement('th');
      sth.className='sticky dept sum'; sth.textContent='Summe Wochen (indiziert)'; sr.appendChild(sth);
      weeks.forEach(weekStart=>{
        const td = document.createElement('td'); 
        // if any DEPT of this project has an assigned person on any day of this week => mark
        const daysOfWeek = [...Array(7)].map((_,i)=>{
          const d = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate()+i);
          return d.toISOString().slice(0,10);
        });
        let any = false;
        daysOfWeek.forEach(dayISO=>{
          DEPTS.forEach(dep=>{
            const key = `${dayISO}|D_${dep}`;
            if(p.data[key] && p.data[key].trim()) any = true;
          });
        });
        if(any) td.textContent = '•';
        sr.appendChild(td);
      });
      tbody.appendChild(sr);

      // project gap row
      const gap = document.createElement('tr'); gap.className='project-gap-row';
      const gapTd = document.createElement('td'); gapTd.colSpan = weeks.length + 1;
      gap.appendChild(gapTd);
      tbody.appendChild(gap);
    });

    tbl.appendChild(tbody);
    container.appendChild(tbl);
  }
  </script>
</body>
</html>
